@using AubgEMS.Core.Models.Common
@using AubgEMS.Core.Models.Events
@model PageResult<EventListItemDto>

@{
    ViewData["Title"] = "Events";
    var query = (AubgEMS.Core.Models.Events.EventQuery)ViewBag.Query;
}

<!-- Header -->
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb small">
    <li class="breadcrumb-item">
      <a asp-controller="Home" asp-action="Index">Home</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Events</li>
  </ol>
</nav>

<div class="mb-3">
  <h1 class="page-title">Events</h1>
  <p class="page-subtitle">Browse and filter upcoming events.</p>
</div>

<form method="get" class="row g-2 mb-4">
    <div class="col-12 col-md-3">
        <label class="form-label">Event Type</label>
        <select class="form-select" name="EventTypeId" asp-items="ViewBag.EventTypes">
            <option value="">All</option>
        </select>
    </div>

    <div class="col-12 col-md-3">
        <label class="form-label">Department</label>
        <select class="form-select" name="DepartmentId" asp-items="ViewBag.Departments">
            <option value="">All</option>
        </select>
    </div>

    <div class="col-12 col-md-3">
        <label class="form-label">Club</label>
        <select class="form-select" name="ClubId" asp-items="ViewBag.Clubs">
            <option value="">All</option>
        </select>
    </div>

    <div class="col-12 col-md-3">
        <label class="form-label">Search</label>
        <input class="form-control" type="text" name="Search" value="@(query?.Search ?? "")" placeholder="title or description..." />
    </div>

    <input type="hidden" name="Page" value="@(query?.Page ?? 1)" />
    <input type="hidden" name="PageSize" value="@(query?.PageSize ?? 10)" />

    <div class="col-12 mt-2">
        <button class="btn btn-primary">Apply</button>
        <a class="btn btn-outline-secondary ms-2" asp-action="Index">Reset</a>
    </div>
</form>

@if (Model.TotalCount == 0)
{
    @await Html.PartialAsync("_EmptyState", new AubgEMS.Models.EmptyStateViewModel {
        Icon = "bi-calendar2-x",
        Title = "No events match your filters",
        Message = "Try adjusting the filters or clearing your search.",
        ActionText = "Reset filters",
        ActionController = "Events",
        ActionAction = "Index"
    })
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        @foreach (var e in Model.Items)
        {
            <div class="col">
                @await Html.PartialAsync("_EventCard", e)
            </div>
        }
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            Page @Model.Page â€¢ @Model.TotalCount total
        </div>

        @{
            // Preserve current filters in pager links
            var routes = new Dictionary<string,string?> {
                ["EventTypeId"]  = query?.EventTypeId?.ToString(),
                ["DepartmentId"] = query?.DepartmentId?.ToString(),
                ["ClubId"]       = query?.ClubId?.ToString(),
                ["Search"]       = query?.Search
            };
        }
        @await Html.PartialAsync("_Pager", new AubgEMS.Models.PagerViewModel {
            Page = Model.Page,
            PageSize = Model.PageSize,
            TotalCount = Model.TotalCount,
            Controller = "Events",
            Action = "Index",
            RouteValues = routes
        })
    </div>
}